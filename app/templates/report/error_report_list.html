<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>장애 리포트 목록</title>
  <link rel="stylesheet" href="/static/style.css">
  <script>
    function toggleFilter() {
      const filter = document.getElementById('filter-section');
      filter.style.display = filter.style.display === 'none' ? 'block' : 'none';
    }
  </script>
</head>
<body>
  {% include 'layout/header.html' %}
  <div class="container">
    <div class="section">
      <h2>장애 리포트 목록</h2>

      <div class="filter-bar">
        <form method="get" style="display: flex; gap: 10px;">
          <input type="text" name="search" placeholder="통합 검색" value="{{ request.query_params.get('search', '') }}">
          <button type="submit">검색</button>
          <button type="button" onclick="toggleFilter()">필터링</button>
        </form>
      </div>
      

      <form id="filter-section" method="get" style="display: none;">
        <div class="form-row">
          <div>
            <label>장애일자:</label>
            <input type="date" name="start_date" value="{{ request.query_params.get('start_date', '') }}">
          </div>
          <div>
            <label style="visibility:hidden;">~</label>
            <input type="date" name="end_date" value="{{ request.query_params.get('end_date', '') }}">
          </div>
        </div>

        <div class="form-row">
          <div>
            <label>장애상태:</label>
            <select name="status">
              <option value="">전체</option>
              <option value="대기" {% if request.query_params.get('status') == '대기' %}selected{% endif %}>대기</option>
              <option value="진행 중" {% if request.query_params.get('status') == '진행 중' %}selected{% endif %}>진행 중</option>
              <option value="완료" {% if request.query_params.get('status') == '완료' %}selected{% endif %}>완료</option>
            </select>
          </div>
          <div>
            <label>담당자:</label>
            <input type="text" name="manager" value="{{ request.query_params.get('manager', '') }}">
          </div>
        </div>

        <div class="form-row">
          <div>
            <label>고객사:</label>
            <input type="text" name="client_name" value="{{ request.query_params.get('client_name', '') }}">
          </div>
          <div>
            <label>시스템명:</label>
            <input type="text" name="system_name" value="{{ request.query_params.get('system_name', '') }}">
          </div>
        </div>

        <div class="form-row">
          <div>
            <label>대상시스템/환경:</label>
            <input type="text" name="target_env" value="{{ request.query_params.get('target_env', '') }}">
          </div>
          <div>
            <label>장애대상:</label>
            <input type="text" name="target_component" value="{{ request.query_params.get('target_component', '') }}">
          </div>
        </div>

        <div class="button-group">
          <button type="submit">검색</button>
          <a href="/error_reports"><button type="button">초기화</button></a>
        </div>
      </form>

      <table>
        <thead>
          <tr>
            <th>장애일자</th><th>고객사</th><th>시스템명</th><th>대상환경</th><th>장애대상</th><th>상태</th><th>담당자</th><th>장애내용</th>
          </tr>
        </thead>
        <tbody>
          {% for report in reports %}
          <tr>
            <td><a href="/report/{{ report.report_id }}?type=error">{{ report.error_start_date.strftime('%Y-%m-%d') if report.error_start_date }}</a></td>
            <td>{{ report.client_name }}</td>
            <td>{{ report.system_name }}</td>
            <td>{{ report.target_env }}</td>
            <td>{{ report.target_component }}</td>
            <td>{{ report.status }}</td>
            <td>{{ report.manager }}</td>
            <td>{{ report.error_info }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      {% set query_string = '' %}
      {% for k, v in request.query_params.items() %}
        {% if k != 'page' %}
          {% if query_string %}{% set query_string = query_string ~ '&' %}{% endif %}
          {% set query_string = query_string ~ k ~ '=' ~ v %}
        {% endif %}
      {% endfor %}

      <div class="pagination">
        {% if page > 1 %}
          <a href="?{{ query_string }}&page=1">&laquo;</a>
          <a href="?{{ query_string }}&page={{ page -1 }}">&lsaquo;</a>
        {% endif %}
        {% for p in range(start_page, end_page + 1) %}
          {% if p == page %}
            <span class="current">{{ p }}</span>
          {% else %}
            <a href="?{{ query_string }}&page={{ p }}">{{ p }}</a>
          {% endif %}
        {% endfor %}
        {% if page < total_pages %}
          <a href="?{{ query_string }}&page={{ page +1 }}">&rsaquo;</a>
          <a href="?{{ query_string }}&page={{ total_pages }}">&raquo;</a>
        {% endif %}
      </div>

      <div class="download-link">
        <button onclick="toggleDownload()" class="csv-download-btn">CSV 다운로드</button>
        <form method="get" action="/error_reports/download" id="download-form" style="display: none; margin-top: 10px;">
          <input type="date" name="start_date" required>
          <span>~</span>
          <input type="date" name="end_date" required>
          <button type="submit" class="csv-download-btn">다운로드</button>
        </form>
      </div>

      <script>
        function toggleDownload() {
          const form = document.getElementById('download-form');
          form.style.display = form.style.display === 'none' ? 'flex' : 'none';
        }
      </script>

    </div>
  </div>
</body>
</html>
